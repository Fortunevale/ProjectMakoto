name: Deploy to Production Server
on: 
  push:
    branches: [ main ]
  workflow_dispatch:

permissions: write-all

jobs:
  build:
    name: Build Project and Upload to Server
    runs-on: self-hosted
    steps:
      - name: Cleanup
        run: rm -rf ProjectMakoto/
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_TOKEN }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOST }}
      - name: Setup .NET Core SDK 7.x
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '7.x'
      - name: "Clone Repository"
        uses: actions/checkout@v3
        with:
          submodules: recursive
          path: ProjectMakoto
          token: ${{ secrets.Access_token }}
      - name: Remove TranslationSourceGenerator from Build
        run: dotnet sln remove ../TranslationSourceGenerator/TranslationSourceGenerator.csproj
        working-directory: ProjectMakoto/ProjectMakoto/
      - name: Install Dependencies
        run: dotnet restore
        working-directory: ProjectMakoto/ProjectMakoto/
      - name: Build Makoto
        run: dotnet publish --configuration RELEASE --runtime linux-x64 --no-self-contained --output "build" --property:PublishDir="build"
        working-directory: ProjectMakoto/ProjectMakoto/
      - name: Create Version File
        run: git rev-parse --short HEAD > "ProjectMakoto/build/LatestGitPush.cfg" && git branch --show-current >> ProjectMakoto/build/LatestGitPush.cfg && echo $(date +%d.%m.%y) >> ProjectMakoto/build/LatestGitPush.cfg && echo $(date +%H:%M:%S,00) >> ProjectMakoto/build/LatestGitPush.cfg
        working-directory: ProjectMakoto/
      - name: Deploy to Production Server
        run: rsync -avz --delete --force -e "ssh -p ${{ secrets.SSH_PORT }}" . ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_SERVER }}:/home/${{ secrets.SSH_USERNAME }}/Bots/latestProjectIchigo/
        working-directory: ProjectMakoto/ProjectMakoto/build/
      - name: Send Update Signal to Production Client
        run: ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_SERVER }} -p ${{ secrets.SSH_PORT }} touch /home/${{ secrets.SSH_USERNAME }}/Bots/ProjectIchigo/updated
      - name: Create Zip File from Build
        run: zip -r Release.zip build
        working-directory: ProjectMakoto/ProjectMakoto/
      - name: Truncate String
        uses: 2428392/gh-truncate-string-action@v1.2.0
        id: truncatedString
        with:
          stringToTruncate: ${{ github.sha }}
          maxLength: 10
      - name: Create Release
        uses: ncipollo/release-action@v1.13.0
        with:
          artifacts: "ProjectMakoto/ProjectMakoto/Release.zip"
          generateReleaseNotes: true
          prerelease: true
          tag: ${{ steps.truncatedString.outputs.string }}
          commit: ${{ github.sha }}
      - name: Cleanup
        run: rm -rf ProjectMakoto/
        if: always()